#### Installation ####
# File: .zshrc or .bashrc or ...
# Add:  source ~/.my_profile
# Done...

### Determine OS being used ###

MY_OS=$(uname)
case $MY_OS in
  'Linux')
    MY_OS='linux'
    ;;
  'WindowsNT')
    MY_OS='dos'
    ;;
  'Darwin')
    MY_OS='darwin'
    ;;
  *) ;;
esac

### Determine ARCH being used ###

MY_ARCH=$(uname -m)
case $MY_ARCH in
  x86_64)
    MY_ARCH=x64  # or AMD64 or Intel64 or whatever
    ;;
  i*86)
    MY_ARCH=x86  # or IA32 or Intel32 or whatever
    ;;
  *)
    ;;
esac

### Determine DISTRO being used ###

# by type
MY_DISTRO=$(uname)
case $MY_DISTRO in
  Linux )
    # test for distro by command
    MY_DISTRO=$(cat /proc/version)
    if [[ "$MY_DISTRO" == *"Ubuntu"* ]]; then
      MY_DISTRO=debian
    elif [[ "$MY_DISTRO" == *"Red Hat"* ]]; then
      MY_DISTRO=rhel
    fi
    ;;
  Darwin )
     MY_DISTRO=darwin
     ;;
  * )
     ;;
esac
 
### Determine SHELL being used ###

MY_SHELL=$(echo $0)
#MY_SHELL=$SHELL
if [[ $MY_SHELL == *zsh* ]]; then
  #!/bin/zsh
  MY_SHELL=zsh
elif [[ $MY_SHELL == *bash* ]]; then
  #!/bin/bash
  MY_SHELL=bash
fi

### Determine TERM being used ###

MY_TERM=$TERM
if [[ $MY_TERM == *xterm* ]]; then
  MY_TERM=xterm
fi

# Display env. in terminal
if [[ "$@" == *"-v"* ]]; then
  echo "$MY_OS $MY_DISTRO $MY_ARCH $MY_TERM $MY_SHELL"
  echo ""
fi

### Terminal History ###

# Saving HISTFILESIZE lines to disk and loading the last HISTSIZE lines into memory
HISTSIZE=5000
HISTFILESIZE=10000
# Append history from each session, not the last terminal to log out
if [[ $MY_SHELL == bash ]]; then
  shopt -s histappend > /dev/null 2>&1
elif [[ $MY_SHELL == zsh ]]; then
  setopt INC_APPEND_HISTORY > /dev/null 2>&1
fi
# Add commands immediatley to history, not wait for log out
export PROMPT_COMMAND="history -a; history -c; history -r; $PROMPT_COMMAND"

### Configuration ###

if [[ ! "$@" == *"-w"* ]]; then
  # create permissions
  # in octal (777 - 750 = 027)
  umask 0027
fi

# expand aliases for on-interactive shell (i.e. scripts)
if [[ $MY_SHELL == bash ]]; then
  shopt -s expand_aliases
elif [[ $MY_SHELL == zsh ]]; then
  setopt aliases
fi

### Variables ###

export SUCCESS=0
export FAIL=1
export EDITOR='vim'

# GO's environment 
if [[ $MY_OS == darwin ]]; then
  export PATH=$PATH:/usr/local/opt/go/libexec/bin
  export GOPATH=/usr/local/opt/go/bin
fi

### The Magic ###
if type htop > /dev/null 2>&1; then
  alias top='htop'
fi
alias vi='vim'
alias curl='noglob curl'
# not the real God, hence lowercase.
alias god='sudo'
alias please='god'
alias c='clear'
alias h='history'
alias quit='exit'
alias q='quit'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias mkdir='mkdir -pv'
if [[ $MY_OS == darwin ]]; then
  alias df='df -ha'
else
  alias df='df -Tha'
fi
alias du='du -ach'
alias free='free -mt'
alias here='find . -iname'
alias whereami='uname -a'
alias echoerr='>&2 echo'
# w/ millisecond
alias now='date +"%m-%d-%Y %T.%3N"'
## safety
alias rm='rm -i'
alias cp='cp -i'
alias mv='mv -i'
alias random='cat /dev/urandom | tr -cd 'a-f0-9' | head -c 64 | cut -c 1-'
alias reboot='sudo shutdown -r now'
alias shutdown='sudo shutdown now'
alias plogout='sudo pkill -KILL -u'
alias apt-get='sudo apt-get'
# search process match (e.g. psf name)
alias psf='ps | grep -v grep | grep -i -e VSZ -e'
if [[ $MY_OS == darwin ]]; then
  alias ls='ls -LGpF'
else
  alias ls='ls -LpF --color=auto'
fi
alias l='ls'
alias ll='ls -LlAh'
alias l.='ls -Ld .*'
alias la='ls -lah'
if [[ $MY_OS == darwin ]]; then
  # gnu util for darwin
  alias timeout='gtimeout'
  alias ps='ps aux'
else 
  alias ps='ps auxf'
fi

# with xsession
alias ssh='ssh -X'

# ISO-8601 compliant date (in mongodb formate)
alias utc='date -u "+%Y-%m-%dT%H:%M:%S.%3NZ"'

vboxmanage()
{
  if [ -n "$1" ] && [[ "$1" == "--upgrade" ]]; then
    version=$(vboxmanage -v)
    var1=$(echo $version | cut -d 'r' -f 1)
    var2=$(echo $version | cut -d 'r' -f 2)
    file="Oracle_VM_VirtualBox_Extension_Pack-$var1-$var2.vbox-extpack"
    wget http://download.virtualbox.org/virtualbox/$var1/$file -O /tmp/$file
    sudo command VBoxManage extpack install /tmp/$file --replace
    sudo /sbin/rcvboxdrv setup
  elif [ -n "$1" ] && [[ "$1" == "--shutdown" ]]; then
    _vms=`vboxmanage list runningvms|cut -d" " -f 1 | tr -d '"'`
    for _vm in $_vms; do
      vboxmanage controlvm $_vm poweroff soft
    done
  else
    command vboxmanage "$@"
  fi
  version=$(vboxmanage -v)
}

if [[ $MY_DISTRO == debian ]]; then
  upgrade() {
    apt-get update
    apt-get dist-upgrade
    apt-get upgrade
    apt-get autoclean
    apt-get autoremove
    sudo npm i -g npm
    sudo npm -g upgrade
    sudo -H pip install -U `sudo -H pip list --outdated | awk '{ print $1}'`
    sudo -H pip3 install -U `sudo -H pip3 list --outdated | awk '{ print $1}'`
    sudo gem update 
    sudo gem cleanup 
    git -C $ZSH pull
  }
fi
if [[ $MY_DISTRO == darwin ]]; then
  upgrade() {
    brew update 
    brew upgrade
    brew cleanup
    brew cask cleanup
    brew linkapps
    sudo npm i -g npm
    sudo npm -g upgrade
    sudo -H pip install -U `sudo -H pip list --outdated | awk '{ print $1}'`
    sudo -H pip3 install -U `sudo -H pip3 list --outdated | awk '{ print $1}'`
    gem update
    sudo sh -c "GEM_HOME=/System/Library/Frameworks/Ruby.framework/Versions/2.0/usr/lib/ruby/gems/2.0.0 gem cleanup"
    git -C $ZSH pull
    #mas upgrade
  }
  alias mdtool='/Applications/Xamarin\ Studio.app/Contents/MacOS/mdtool'
fi
# replace awk with ag if found
if type ag > /dev/null 2>&1; then
  alias ack='ag'
fi
if type autojump > /dev/null 2>&1; then
  alias j='autojump'
fi
alias twitter='sudo rainbowstream -iot'
alias irc='weechat'

if [[ $MY_OS == darwin ]]; then
  here() {
    find . -iname $1 2>&1 | grep -v "Permission denied"
  }
fi

# retry command 
# usage: retry <command>
retry() {
  _result=1    
  while [ $_result -ne 0 ] ; do 
    "$@" && break 
    result=$?
	  sleep 3
  done
}

# public ip
ipPub() {
    curl -s checkip.dyndns.org | sed -e 's/.*Current IP Address: //' -e 's/<.*$//'
}

# speed test
speedtest() {
  if type speedtest-cli > /dev/null 2>&1; then
   speedtest-cli
  elif type ./.local/bin/speedtest-cli > /dev/null 2>&1; then
    ./.local/bin/speedtest-cli
  else
    ipPub
    curl -o /dev/null http://speedtest.wdc01.softlayer.com/downloads/test10.zip
  fi
}

# like dos
pause(){
  read -rsp $'Press any key to continue...\n' -n 1 key
}

# show or not to show contents
herein() {
  if [ -n "$1" ] && [[ "$1" == "-s" ]]; then
    shift
    grep -Rni -A 1 -B 1 . -e "$@"
  else
    grep -Rnli . -e "$@"
  fi
}

# list after each cd
cd() {
  if [ -n "$1" ]; then
    builtin cd "$@" && pwd && ls
  else
    builtin cd ~ && pwd && ls
  fi
}

# docker over-load
docker() {
  if [ -n "$1" ] && [[ "$1" == "--reset" ]]; then
    # remove containers not currently running
    command docker rm $(command docker ps -a -f status=exited -q) || true
    # remove images
    command docker rmi $(command docker images -f -q)|| true
    # remove dangling volumes
    command docker volume rm $(command docker volume ls -f -q) || true
  elif [ -n "$1" ] && [[ "$1" == "--init" ]]; then
    sudo iptables -t nat -F
    sudo ifconfig docker0 down
    sudo brctl delbr docker0
    sudo service docker restart
  else
    command docker "$@"
  fi
}

#if [[ $MY_SHELL == *zsh* ]]; then
#  which() {
#    (alias; declare -f) | command which --tty-only --read-alias --read-functions --show-tilde --show-dot $@
#  }
#elif [[ $MY_SHELL == *bash* ]]; then
#  alias which 'alias | command which --tty-only --read-alias -read-functions --show-dot --show-tilde'
#  export -f which
#fi

# history info "-i [depth]" added
history() {
  if [ -n "$1" ] && [[ "$1" == "-i" ]]; then
    local _depth=10
    if [ -n "$2" ]; then
      local _depth=$2
    fi
    builtin history | awk '{CMD[$2]++;count++;}END { for (a in CMD)print CMD[a] " " CMD[a]/count*100 "% " a;}' | grep -v "./" | column -c3 -s " " -t | sort -nr | nl |  head -n$_depth
  else
    builtin history "$@"
  fi
}

screen() {
  local _session="default"
  # if no option(s), run default
  if [ -z "$1" ]; then
    # do not allow a screen inside a screen
    if [ -z "$STY" ]; then
      # if default screen not already running
      if [[ $(screen -list) != *$_session* ]]; then
        # create and attach
        command screen -D -R $_session
      else
        # re-attach if session started elsewhere (i.e. shared) or is detached
        command screen -xr $_session
      fi
    fi
  else
     command screen "$@"
  fi
}

mux()
{
  if [ -n "$1" ] && [[ "$1" == "-k" ]]; then
    if [ -n "$2" ]; then
      command tmux kill-session -t $2
    else
      command tmux kill-session
    fi
  else
    command mux "$@"
  fi
}

# kill vnc window(s) option added
vncserver()
{
  if [ -n "$1" ] && [[ "$1" == "-kill" ]] && [ -n "$2" ] && [[ "$2" == "all" ]]; then
    for v in ~/.vnc/*.pid
    do
      local _window=$(basename "$v" .pid)
      command vncserver -kill $_window
    done
  else
    command vncserver "$@"
  fi
}

# make space in terminal for scrolling
s() {
  space
}

space() {
  for i in {1..50}
  do
   echo ""
  done
  clear
}

# terminal screen saver (matrix)
if type cmatrix > /dev/null 2>&1; then
  tss() {
    cmatrix
    clear
  }
fi

### Key Bindings ###

if [[ $MY_TERM == xterm ]]; then
  # backspace work instead of delete ^H
  stty erase '^?'
fi

# bind keys per shell and terminal
if [[ $MY_SHELL == zsh ]]; then
  # home and end keys
  bindkey '\e[1~' beginning-of-line
  bindkey '\e[4~' end-of-line  
fi

### Other ###

if [[ $MY_OS == darwin ]]; then
  if type archey > /dev/null 2>&1; then
    archey
  fi

  alias afplay='afplay -q 1'.

  # For fun...
  # play funny sounds from terminal
  source ~/.sounds/.sound > /dev/null 2>&1
fi

function finish {
  echo ""
}
trap finish EXIT
